<html>
   <head>
      <title>Pong</title>
    
      <script src="/socket.io/socket.io.js"></script>
      <script>
        
        start = function(){
          SpielfeldAufbauen()
          handleDocumentKeyboardEvents()
          connectToServer()

        }

        window.onload = start

      </script>
      <script>

      </script>
      <script>



        var player
        var socket

        connectToServer = function(){
          
          console.log('connecting to server ...')

          socket = createSocketConnectingToServer()          

          startListeningToEventsFromServer(socket)
        }

        createSocketConnectingToServer = function(){
          return io.connect('http://192.168.1.157:8080')
        }

        startListeningToEventsFromServer = function(s){
          handleServerAcceptedEvent(s)
          handleOtherPlayerMoveEvent(s)
          handleOtherPlayerTriggeredStartEvent(s)
        }

        handleServerAcceptedEvent = function(s){
         
          s.on('accepted', function (data) {
            
            setCurrentUserToBePlayerNumber(data.player)

          });

        }
      
        setCurrentUserToBePlayerNumber = function(playerNumber) {

          player = playerNumber
          console.log('Du bist Spieler '+ player)
          
          setText('playerInfo', playerNumber)
        }

        setText = function(tagId, text){

          var element = document.getElementById(tagId)
          element.innerHTML = text

        }


        handleOtherPlayerMoveEvent = function(s){
          
          s.on('move', function (data){
          
            switch (data.direction){
              case 'up':
              SchlaegerLinks.move(-10); 
              break

              case 'down':
              SchlaegerLinks.move(10); 
              break
            }
          })
        }

        handleOtherPlayerTriggeredStartEvent = function(s){
          s.on('start', function (){
              NeueRunde()             
          })
        }

        starteSpiel = function(){
          if (player == 1){
           console.log('Das Spiel startet')
           socket.emit('start')
          }
        }

        sendUp = function(){
          console.log('up')
          socket.emit('move', { direction: 'up', player:player});
        }

        sendDown = function(){
          console.log('down')
          socket.emit('move', { direction: 'down', player:player});
        }
       


        var hoehe = 350
        var breite = 700                    
        var size = { hoehe: 75, breite: 15 }

        SpielfeldAufbauen = function() {
          rahmenDesSpielfeldes()
          schlaegerUndBall()
        }

      rahmenDesSpielfeldes = function(){
        feldErstellen()
        netzErstellen()
        trefferanzeigeErstellen()
      }
      schlaegerUndBall = function(){
        ballErstellen()
        schlaegerErstellen()
      }

      feldErstellen = function(){
        Feld = new FeldNeu({ hoehe: hoehe, breite: breite });
        document.body.appendChild(Feld);
      }

      FeldNeu = function(size) {
        var block = new BlockNeu({ x: 15, y: 15 }, size, "green")
        return block
      }

      netzErstellen = function(){
        Netz = new NetzNeu({                                    
          x: breite / 2, y: 0
        }, {
         hoehe: hoehe, breite: 2
        }, 40);
        Feld.appendChild(Netz);
      }

      NetzNeu = function(position, size, nodash) {                 
        block = new BlockNeu(position, size, "green")
        block.p = position
        block.s = size
        
        for (i = 0; i < nodash; i++) {
          Strich = new BlockNeu({ x: 0, y: i * 2 * block.s.hoehe / (2*nodash) }, { hoehe: size.hoehe / (2 * nodash), breite: size.breite }, "white")
          block.appendChild(Strich)
        }
        return block;
      };
      trefferanzeigeErstellen = function(){
        linkeAnzeigeWirdErstellt()
        rechteAnzeigeWirdErstellt()
      }
        
      linkeAnzeigeWirdErstellt = function(){  
        AnzeigeL = new AnzeigeNeu({ x: breite / 4, y: 5 }, { breite: 20, hoehe: 40 })
        AnzeigeL.setValue(0)
        Feld.appendChild(AnzeigeL)
      }

      rechteAnzeigeWirdErstellt = function(){
        AnzeigeR = new AnzeigeNeu({ x: 3 * breite / 4, y: 5 }, { breite: 20, hoehe: 40 });
        AnzeigeR.setValue(0);
        Feld.appendChild(AnzeigeR);
      }

    BlockNeu = function(position, size, c) {
      var block = document.createElement("div")
      block.style.position = "absolute"
      block.style.width = size.breite + 'px'
      block.style.height = size.hoehe + 'px'
      block.style.top = position.y + 'px'
      block.style.left = position.x + 'px'
      block.style.backgroundColor = c
      return block
    }


    ballErstellen = function(){
      Ball = new BallNeu({                     
        x: 345, y: 170
      }, {
        x: -2,
        y: 2
      }, 10)

      Feld.appendChild(Ball)
    }

    BallNeu = function(position, velocity, radius) {
      block = new BlockNeu(position, { hoehe: radius, breite: radius }, "white")
      block.p = position
      block.v = velocity
      block.r = radius
      block.move = function(){
        this.p.x += this.v.x                                
        this.p.y += this.v.y
        this.style.top = this.p.y + 'px'
        this.style.left = this.p.x + 'px'

        this.play = 0
        if (this.p.x + this.r > parseInt(this.parentNode.style.width))
            this.play = 1
        if (this.p.x < 0)
            this.play = 2
        if (this.p.y + this.r > parseInt(this.parentNode.style.height))
            this.v.y = -this.v.y
        if (this.p.y < 0)
            this.v.y = -this.v.y
        return this.play
      }
    return block
    }


    schlaegerErstellen = function(){      
      linkerSchlaegerWirdErstellt()
      rechterSchlaegerWirdErstellt()
    }

    linkerSchlaegerWirdErstellt = function(){
      SchlaegerLinks = new SchlaegerNeu({
        x: 15, y: (hoehe / 2 - 25)
      }, {
        hoehe: 75, breite: 15
      })
      Feld.appendChild(SchlaegerLinks)
    }
    
    rechterSchlaegerWirdErstellt = function(){
      SchlaegerRechts = new SchlaegerNeu({
        x: breite - 15 - 10, y: (hoehe / 2 - 30)
      }, {
        hoehe: 75, breite: 15 
      })
      Feld.appendChild(SchlaegerRechts)
    }

    SchlaegerNeu = function(position, size) {
      block = BlockNeu(position, size, "white")
      block.p = position
      block.s = size
      block.move = function(d) {
        this.p.y += d
        this.style.top = this.p.y + 'px'
      }

      block.trifft = function(B){
        if (((B.p.x + B.r) >= this.p.x) && (B.p.x <= (this.p.x + this.s.breite))) {
          if (B.p.y >= this.p.y && B.p.y <= (this.p.y + this.s.hoehe)) {
            B.v.x = -B.v.x;
          }
        }
      }
      return block;
    };

    TimerNeu = function(tick, code) {
      this.timer = window.setInterval(code, tick);
      this.clearTimer = function() {
        window.clearInterval(this.timer)
      }
    }

update = function() {                       
    var zustand = Ball.move()                  
    if (zustand != 0){
        Timer.clearTimer()

        if (zustand == 1) {
           AnzeigeL.setValue(AnzeigeL.value + 1);
        } else {
            AnzeigeR.setValue(AnzeigeR.value + 1);
          }

        pruefeObSpielerGewonnenHat()

        
    }
    pruefeObSpielerGewonnenHat = function(){
    if (AnzeigeL.value == 9 || AnzeigeR.value == 9) {
            Timer.clearTimer()
       } else {
           
            NeueRunde();
        }
    }

    SchlaegerLinks.trifft(Ball);
    SchlaegerRechts.trifft(Ball);
}

  ErkennenDerTasten = function(e) {                                        
    var e = window.event ? event : e;

    if (e.keyCode) { key = e.keyCode; }
    else if (typeof (e.which) != 'undefined') { key = e.which; }

    abfrageDerTasten()
  }

    abfrageDerTasten = function(){

      if (player == 1){
        switch (key) {       
          case (32):                                        
            NeueRunde()
            break
        }
      }

      var schlaeger = player == 1 ? SchlaegerLinks:SchlaegerRechts

      switch (key) {       
        case (115):                                   
          schlaeger.move(10)                         
          sendDown()
          break
        case (119):                                   
          schlaeger.move(-10)                        
          sendUp()
          break     
      }
    }

handleDocumentKeyboardEvents = function(){
  document.onkeypress = ErkennenDerTasten
}

AnzeigeNeu = function(position, size) {
  block = new BlockNeu(position, size, "green")
  block.p = position
  block.s = size
  block.score = 0
  block.Strich = []
  
  for (i = 0; i < 3; i++) {
    block.Strich[i] = new BlockNeu({ x: 1, y: (i * block.s.hoehe / 2) }, { hoehe: 3, breite: block.s.breite - 2 }, "white")
    block.appendChild(block.Strich[i])
  }

  for (i = 0; i < 2; i++) {
    block.Strich[i + 3] = new BlockNeu({ 
      x: 0, y: i * block.s.hoehe / 2 + 4 
    }, { hoehe: block.s.hoehe / 2 - 5, breite: 3 }, "white")
    block.appendChild(block.Strich[i + 3])

    block.Strich[i + 5] = new BlockNeu({ 
      x: block.s.breite - 3, y: i * block.s.hoehe / 2 + 4 
      }, { hoehe: block.s.hoehe / 2 - 5, breite: 3 
      }, "white")
    block.appendChild(block.Strich[i + 5])
  }

var Segmente=new Array(
      [0, 2, 3, 4, 5, 6],
      [3, 4],
      [0, 5, 1, 4, 2],
      [0, 5, 1, 2, 6],
      [1, 3, 5, 6],
      [0, 1, 2, 3, 6],
      [1, 2, 3, 4, 6],
      [0, 5, 6],
      [0, 1, 2, 3, 4, 5, 6],
      [0, 1, 3, 5, 6])

    block.setValue = function(value) {
        this.value = value;        
        for (i = 0; i < 7; i++) {
            this.Strich[i].style.backgroundColor = "green"
        }
        for (i in Segmente[value]) {
            this.Strich[Segmente[value][i]].style.backgroundColor = "white"
        }
    }
    return block;
}

    NeueRunde = function() {
      starteSpiel()
      Ball.p = { x: 345, y: 170}
      Ball.v = { x: 3, y: 3}
      Timer = new TimerNeu(20, update)
    }

  </script>
</head>
 <body>
   <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
   <TABLE BORDER=10 bgcolor=green>
     <TR align=center>
       <TD><font color=white></TD>
       <TD><font color=white>Steuerung</TD>  
     </TR>
     <TR align=center>
       <TD><font color=white>Nach oben</TD>
       <TD><font color=white>W</TD>
     </TR>
     <TR align=center>
       <TD><font color=white>Nach unten</TD>
       <TD><font color=white>S</TD>
     </TR>
   </TABLE>

   <div id='playerInfo'></div>
 </body>
</html>