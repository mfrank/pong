<html>
   <head>
      <title>Pong</title>
    
      <script src="/socket.io/socket.io.js"></script>
      <script>
        
        start = function(){
          SpielfeldAufbauen()
          handleDocumentKeyEvents()
          connectToServer()
        }

        window.onload = start

      </script>
      <script>

        var player
        var socket

        connectToServer = function(){
          
          console.log('connecting to server ...')

          socket = createSocketConnectingToServer()          

          startListeningToEventsFromServer(socket)
        }

        startListeningToEventsFromServer = function(s){
          handleServerAcceptedEvent(s)
          handleOtherPlayerMoveEvent(s)
          handleOtherPlayerTriggeredStartEvent(s)
        }

        createSocketConnectingToServer = function(){
          return io.connect('http://192.168.1.157:8080')
        }

        handleServerAcceptedEvent = function(s){
         
          s.on('accepted', function (data) {
            console.log('Du bist Spieler '+data.player)
            player = data.player

            s.emit('my other event', { my: 'data' });
          });
        }
      
        handleOtherPlayerMoveEvent = function(s){
          
          s.on('move', function (data){
          
            switch (data.direction){
              case 'up':
              SchlaegerLinks.move(-10); 
              break

              case 'down':
              SchlaegerLinks.move(10); 
              break
            }
          })
        }

        handleOtherPlayerTriggeredStartEvent = function(s){
          s.on('start', function (){
              NeueRunde()             
          })
        }

        starteSpiel = function(){
          if (player == 1){
           console.log('Das Spiel startet')
           socket.emit('start')
          }
        }

        sendUp = function(){
          console.log('up')
          socket.emit('move', { direction: 'up', player:player});
        }

        sendDown = function(){
          console.log('down')
          socket.emit('move', { direction: 'down', player:player});
        }
       


  var hoehe = 350;
  var breite = 700;                    
  var size = {
    hoehe: 75, breite: 15
  }

    SpielfeldAufbauen = function() {
      rahmenDesSpielfeldes()
      schlaegerUndBall()
    }

      rahmenDesSpielfeldes = function(){
        feldErstellen()
        netzErstellen()
        trefferanzeigeErstellen()
      }
      schlaegerUndBall = function(){
        ballErstellen()
        schlaegerErstellen()
      }




BlockN = function(position, size, c) {
    var block = document.createElement("div")
    block.style.position = "absolute"
    block.style.width = size.breite + 'px'
    block.style.height = size.hoehe + 'px'
    block.style.top = position.y + 'px'
    block.style.left = position.x + 'px'
    block.style.backgroundColor = c
    return block
}


feldErstellen = function(){
      Feld = new FeldNeu({ hoehe: hoehe, breite: breite });
      document.body.appendChild(Feld);
      }

FeldNeu = function(size) {
    var block = new BlockN({ x: 15, y: 15 }, size, "green")
    return block
}


  netzErstellen = function(){
      Netz = new NetzNeu({                                    
        x: breite / 2, y: 0
      }, {
        hoehe: hoehe,              
        breite: 2
      }, 40);
      Feld.appendChild(Netz);
      }

  NetzNeu = function(position, size, nodash) {                 
      block = new BlockN(position, size, "green")
      block.p = position
      block.s = size
      for (i = 0; i < nodash; i++) {

          Strich = new BlockN({ x: 0, y: i * 2 * block.s.hoehe / (2*nodash) }, { hoehe: size.hoehe / (2 * nodash), breite: size.breite }, "white")
          block.appendChild(Strich)
      }
      return block;
  };

  ballErstellen = function(){
      Ball = new BallNeu({                     
        x: 345, y: 170
      }, {
        x: -2,
        y: 2
      }, 10)

    Feld.appendChild(Ball)
 
  }

BallNeu = function(position, velocity, radius) {
    block = new BlockN(position, { hoehe: radius, breite: radius }, "white")
    block.p = position
    block.v = velocity
    block.r = radius
 block.move = function()
      {
        this.p.x += this.v.x                                
        this.p.y += this.v.y
        this.style.top = this.p.y + 'px'
        this.style.left = this.p.x + 'px'

//Überprüfen, ob der Ball einen Spielfeldrand berührt

        this.play = 0
        if (this.p.x + this.r > parseInt(this.parentNode.style.width))
            this.play = 1
        if (this.p.x < 0)
            this.play = 2
        if (this.p.y + this.r > parseInt(this.parentNode.style.height))
            this.v.y = -this.v.y
        if (this.p.y < 0)
            this.v.y = -this.v.y
        return this.play
    }
    return block
}


  schlaegerErstellen = function(){
    SchlaegerLinks = new SchlaegerNeu({
      x: 15,
      y: (hoehe / 2 - 25)
    }, {
      hoehe: 75, breite: 15
    });
    Feld.appendChild(SchlaegerLinks);

    SchlaegerRechts = new SchlaegerNeu({
        x: breite - 15 - 10,
        y: (hoehe / 2 - 30)
    }, { hoehe: 75, breite: 15 });
    Feld.appendChild(SchlaegerRechts);
  }

  SchlaegerNeu = function(position, size) {
    block = BlockN(position, size, "white")
    block.p = position
    block.s = size
    block.move = function(d) {
        this.p.y += d
        this.style.top = this.p.y + 'px'
    }

//Methode, die überprüft, ob der Schläger den Ball trifft

    block.trifft = function(B) 
      {
        if (((B.p.x + B.r) >= this.p.x) && (B.p.x <= (this.p.x + this.s.breite))) {
            if (B.p.y >= this.p.y && B.p.y <= (this.p.y + this.s.hoehe)) {
                B.v.x = -B.v.x;
            }
        }
    }
    return block;
};

TimerNeu = function(tick, code) {
    this.timer = window.setInterval(code, tick);
    this.clearTimer = function() {
        window.clearInterval(this.timer)
    };
}

update = function() {                        //Ball bewegt sich, überprüfen, ob der Ball im Spiel ist und ob ein Schläger den Ball trifft
    var zustand = Ball.move();                  
    if (zustand != 0)
     {
        Timer.clearTimer();
        if (zustand == 1) {
           AnzeigeL.setValue(AnzeigeL.value + 1);
        } else {
            AnzeigeR.setValue(AnzeigeR.value + 1);
        }
        if (AnzeigeL.value == 9 || AnzeigeR.value == 9) {            //wenn ein Spieler 9 Punkte erreicht hat, endet das Spiel
            Timer.clearTimer()
       } else {
           
            NeueRunde();
        }
    }

    SchlaegerLinks.trifft(Ball);
    SchlaegerRechts.trifft(Ball);
}

 ErkennenDerTasten = function(e) {                                        
    var e = window.event ? event : e;
    if (e.keyCode) { key = e.keyCode; }
    else if (typeof (e.which) != 'undefined') { key = e.which; }
    if (player == 1){
      switch (key) {       
        case (32):                                        
          NeueRunde()
          break;
        case (115):                                   
          SchlaegerLinks.move(10);                         
          sendDown()
          break;
        case (119):                                   
          SchlaegerLinks.move(-10);                        
          sendUp()
          break; }
    }
    if (player == 2){
      switch (key) {
        case (115):                                       
          SchlaegerRechts.move(10);                              
          sendDown()
          break;
        case (119):                                       
          SchlaegerRechts.move(-10);                              
          sendUp()
          break;
      }
    }
}

handleDocumentKeyEvents = function(){
  document.onkeypress = ErkennenDerTasten
}


 trefferanzeigeErstellen = function(){
    AnzeigeL = new AnzeigeN({ x: breite / 4, y: 5 }, { breite: 20, hoehe: 40 });
    AnzeigeL.setValue(0);
    Feld.appendChild(AnzeigeL);
    AnzeigeR = new AnzeigeN({ x: 3 * breite / 4, y: 5 }, { breite: 20, hoehe: 40 });
    AnzeigeR.setValue(0);
    Feld.appendChild(AnzeigeR);
  }

AnzeigeN = function(position, size) {
    block = new BlockN(position, size, "green");
    block.p = position;
    block.s = size;
    block.score = 0;
    block.Strich = [];
 
//Erstellen der horizontalen Striche

   for (i = 0; i < 3; i++) {
        block.Strich[i] = new BlockN({ x: 1, y: (i * block.s.hoehe / 2) }, { hoehe: 3, breite: block.s.breite - 2 }, "white");
        block.appendChild(block.Strich[i]);
    }

//Erstellen der vertikalen Striche

    for (i = 0; i < 2; i++) {

        block.Strich[i + 3] = new BlockN({ 
          x: 0, y: i * block.s.hoehe / 2 + 4 
        }, { hoehe: block.s.hoehe / 2 - 5, breite: 3 }, "white");
        block.appendChild(block.Strich[i + 3]);
        block.Strich[i + 5] = new BlockN({ 
          x: block.s.breite - 3, y: i * block.s.hoehe / 2 + 4 
          }, { hoehe: block.s.hoehe / 2 - 5, breite: 3 
          }, "white");
        block.appendChild(block.Strich[i + 5]);
    }





var Segmente=new Array(
      [0, 2, 3, 4, 5, 6],
      [3, 4],
      [0, 5, 1, 4, 2],
      [0, 5, 1, 2, 6],
      [1, 3, 5, 6],
      [0, 1, 2, 3, 6],
      [1, 2, 3, 4, 6],
      [0, 5, 6],
      [0, 1, 2, 3, 4, 5, 6],
      [0, 1, 3, 5, 6]);
    block.setValue = function(value) {
        this.value = value;

        for (i = 0; i < 7; i++) {
            this.Strich[i].style.backgroundColor = "green";
        }
        for (i in Segmente[value]) {
            this.Strich[Segmente[value][i]].style.backgroundColor = "white"
        }

    }

    return block;
};





    NeueRunde = function() {
      starteSpiel()
      Ball.p = { x: 345, y: 170};
         Ball.v = { x: 3, y: 3};
      Timer = new TimerNeu(20, update);
    }

</script>
</head>





 <body>
   <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

   <TABLE BORDER=5 bgcolor=green>
     <TR align=center>
       <TD><font color=white>Steuerung</TD>
       <TD><font color=white>Spieler 1</TD>  
     </TR>
     <TR align=center>
       <TD><font color=white>Nach oben</TD>
       <TD><font color=white>W</TD>
     </TR>
     <TR align=center>
       <TD><font color=white>Nach unten</TD>
       <TD><font color=white>S</TD>
     </TR>
   </TABLE>
 </body>
</html>
